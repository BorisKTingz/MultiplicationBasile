//based on this article
//https://medium.com/@rafael_toledo/setting-up-an-unified-coverage-report-in-android-with-jacoco-robolectric-and-espresso-ffe239aaf3fa

apply plugin: 'jacoco'
/***********************************************************
 *  This is your Jacoco script
 **********************************************************/

/***********************************************************
 *  Attributes
 **********************************************************/
//define which classes to exclude
def fileFilter = [
        '**/R.class',
        '**/R$*.class',
        '**/BuildConfig.*',
        '**/Manifest*.*',
        '**/*$ViewInjector*.*',
        '**/*$ViewBinder*.*',
        '**/*$Lambda$*.*', // Jacoco can not handle several "$" in class name.
        '**/*Module.*', // Modules for Dagger.
        '**/*Dagger*.*', // Dagger auto-generated code.
        '**/*MembersInjector*.*', // Dagger auto-generated code.
        '**/*_Provide*Factory*.*',
        '**/*_Factory.*', //Dagger auto-generated code
        '**/*$*$*.*', // Anonymous classes generated by kotlin
        //add libraries
        'android/**/*.*',
        'uk/**/*.*',
        'io/**/*.*',
        //remove what we don't test
        'androidTest/**/*.*',
        'test/**/*.*',
        '**/injector/**/*.*',
        '**/model/**/*.*',
        '**/mock/**/*.*',
        '**/event/**/*.*',
        '**/*EventType.*',
        '**/**Mocked',
        '**/AssesmentOperation.*'
]

/***********************************************************
 *  Main task
 **********************************************************/
task jacocoTestReport( dependsOn: [
        ':app:jacocoTestReportBasile',
        ':app:jacocoTestReportLila',
]){

    group = project.ext.myGradleGroup
    description ="Launch all the code coverage analysis for all apk."
}
/***********************************************************
 *  Create Jacoco Report for each application you release
 **********************************************************/
/**
 * Generate the JaCoco report for Basile Apk
 */
task jacocoTestReportBasile(type: JacocoReport, dependsOn: [
        //you depend on nothing because it's called by gWR...but
        //if you want to just generate your reports from scratch uncomment those lines
//        ':app:assembleBasileMultiplicationDebug',
]) {
    group = project.ext.myGradleGroup
    description ="Launch the code coverage analysis for Basile apk."
    reports {
        xml.enabled = true
        html.enabled = true
        xml {
            destination new File("$reportsDir/jacocoBasile/jacocoReportBasile.xml")
        }
        html {
            destination new File("$reportsDir/jacocoBasile/")
        }
    }

    //Define exactly where are the class in your Build folder to analyze
    def debugTreeBasile = fileTree(dir: "${buildDir}/intermediates/classes/basileMultiplication/release",
            excludes: fileFilter)
    def mainSrc = files(["src/main/java",
                         "src/basile/java",
                         "src/addition/java",
                         "src/multiplication/java"])


    //Where are your sources:
    sourceDirectories = files([mainSrc])
    classDirectories = files([debugTreeBasile])
    //As you want to gather all your tests reports, add the ec and exec you want to be took into
    //account when generating the report
    executionData = fileTree(dir: "$buildDir", includes: [
            "jacoco/testBasileMultiplicationDebugUnitTest.exec",
            "jacoco/testBasileMultiplicationReleaseUnitTest.exec",
            "outputs/code-coverage/connected/flavors/**/*coverage.ec"
    ])
}

/**
 * Generate the JaCoco report for Lila Apk
 */
task jacocoTestReportLila(type: JacocoReport, dependsOn: [
        //you depend on nothing because it's called by gWR...but
        //if you want to just generate your reports from scratch uncomment those lines
//        ':app:assembleLilaAdditionDebug',
]) {
    group = project.ext.myGradleGroup
    description ="Launch the code coverage analysis for Basile apk."
    reports {
        xml.enabled = true
        html.enabled = true
        xml {
            destination new File("$reportsDir/jacocoLila/jacocoReportLila.xml")
        }
        html {
            destination new File("$reportsDir/jacocoLila/")
        }
    }

    //Define exactly where are the class in your Build folder to analyze
    def debugTreeLila = fileTree(dir: "${buildDir}/intermediates/classes/lilaAddition/release",
            excludes: fileFilter)
    def mainSrc = files(["src/main/java",
                         "src/lila/java",
                         "src/addition/java",
                         "src/multiplication/java"])


    //Where are your sources:
    sourceDirectories = files([mainSrc])
    classDirectories = files([debugTreeLila])
    //As you want to gather all your tests reports, add the ec and exec you want to be took into
    //account when generating the report
    executionData = fileTree(dir: "$buildDir", includes: [
            "jacoco/testLilaAdditionDebugUnitTest.exec",
            "jacoco/testLilaAdditionEleaseUnitTest.exec",
            "outputs/code-coverage/connected/flavors/**/*coverage.ec"
    ])
}